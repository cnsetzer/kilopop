<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kilopop.kilonovae &mdash; Kilopop beta documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Kilopop
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/tutorial_notebook_1.html">Tutorial: Basic functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledging.html">Acknowledging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/kilopop.equation_of_state.html">kilopop.equation_of_state</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/kilopop.kilonovae.html">kilopop.kilonovae</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/kilopop.macronovae_wrapper.html">kilopop.macronovae_wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/kilopop.mappings.html">kilopop.mappings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/kilopop.population_priors.html">kilopop.population_priors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kilopop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">kilopop.kilonovae</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kilopop.kilonovae</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module with classes and methods for constructing individual kilonovae</span>
<span class="sd"> instances.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">units</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyDeprecationWarning</span>
<span class="c1"># suppress AstropyDeprecationWarning</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AstropyDeprecationWarning</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sncosmo</span> <span class="kn">import</span> <span class="n">TimeSeriesSource</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">kilopop.macronovae_wrapper</span> <span class="kn">import</span> <span class="n">create_saee_seds</span>
<span class="kn">from</span> <span class="nn">kilopop</span> <span class="kn">import</span> <span class="n">equation_of_state</span> <span class="k">as</span> <span class="n">eos</span>
<span class="kn">from</span> <span class="nn">kilopop</span> <span class="kn">import</span> <span class="n">mappings</span>
<span class="kn">from</span> <span class="nn">kilopop</span> <span class="kn">import</span> <span class="n">population_priors</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>


<div class="viewcode-block" id="bns_kilonova"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova">[docs]</a><span class="k">class</span> <span class="nc">bns_kilonova</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Top-level class for kilonovae transients based on Rosswog, et. al 2017</span>
<span class="sd">    semi-analytic model for kilonovae spectral energy distributions. With</span>
<span class="sd">    added mappings and population priors to generate kilonovae consistent with</span>
<span class="sd">    a broad binary neutron star population.</span>

<span class="sd">    Note: all input parameters are optional. If none are provided a kilonova</span>
<span class="sd">    will be generated by drawing parameters from the population priors used</span>
<span class="sd">    in our accompanying paper, Setzer et al. 2022.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    mass1: float</span>
<span class="sd">        The gravitational mass of the first neutron star.</span>
<span class="sd">    mass2: float</span>
<span class="sd">        The gravitational mass of the second neutron star.</span>
<span class="sd">    compactness1: float</span>
<span class="sd">        The stellar compactness of the first neutron star.</span>
<span class="sd">    compactness2: float</span>
<span class="sd">        The stellar compactness of the second neutron star.</span>
<span class="sd">    viewing_angle: float</span>
<span class="sd">        The viewing angle of the observer with respect to the merger.</span>
<span class="sd">    electron_fraction: float</span>
<span class="sd">        The electron fraction along the line of sight of the observer.</span>
<span class="sd">    dynamical_ejecta_mass: float</span>
<span class="sd">        The dynamic ejecta mass of the expanding kilonova material.</span>
<span class="sd">    median_ejecta_velocity: float</span>
<span class="sd">        The mean ejecta velocity of the expanding kilonova material.</span>
<span class="sd">    grey_opacity: float</span>
<span class="sd">        The grey opacity of the material along the line of sight of the</span>
<span class="sd">        observer.</span>
<span class="sd">    secular_ejecta_mass: float</span>
<span class="sd">        The secular ejecta mass of the expanding kilonova material.</span>
<span class="sd">    total_ejecta_mass: float</span>
<span class="sd">        The total ejecta mass of the expanding kilonova material.</span>
<span class="sd">    disk_unbinding_efficiency: float</span>
<span class="sd">        The fractional percentage of matter unbound by disk winds.</span>
<span class="sd">    mass_ratio_threshold: float</span>
<span class="sd">        The lower bound on mass-ratio for which to simulate the binary.</span>
<span class="sd">    transient_duration: float [days]</span>
<span class="sd">        The maximal length of time over which to generate the kilonova signal.</span>
<span class="sd">        Default is 15 days.</span>
<span class="sd">    min_wave: float [Angstroms]</span>
<span class="sd">        The minimum wavelength of the simulated source-frame spectral timeseries.</span>
<span class="sd">    max_wave: float [Angstroms]</span>
<span class="sd">        The maximum wavelength of the simulated source-frame spectral timeseries.</span>
<span class="sd">    EOS_path: string</span>
<span class="sd">        The location of EOS mass vs. radius data for computation of TOV mass,</span>
<span class="sd">        translation between neutron star mass and radius, and computation of</span>
<span class="sd">        the stellar compactness of the component neutron stars.</span>
<span class="sd">    opacity_data_path: string</span>
<span class="sd">        The location of the inferred grey opacity training data for use with</span>
<span class="sd">        the Gaussian process emulator.</span>
<span class="sd">    emulator_path: string</span>
<span class="sd">        The file location of the emulator data needed to reconstruct the</span>
<span class="sd">        Gaussian process emulator for mapping ejecta parameters to grey opacity.</span>
<span class="sd">    id: int</span>
<span class="sd">        Unique ID to associate with specific generated instance of a kilonova.</span>
<span class="sd">        Useful for simulation purposes.</span>
<span class="sd">    only_draw_parameters: Boolean</span>
<span class="sd">        Flag indicating if the spectral timeseries should also be generated</span>
<span class="sd">        for the correspondingly provided or drawn parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------------------</span>
<span class="sd">    object: class instance</span>
<span class="sd">        Instance of this class of kilonovae.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Class variables, saves time cacheing these.</span>
    <span class="n">tov_mass</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">EOS_mass_to_rad</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">threshold_mass</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">grey_opacity_emulator</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">opacity_data</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="bns_kilonova.__init__"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mass1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mass2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compactness1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compactness2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">viewing_angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">electron_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dynamical_ejecta_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">median_ejecta_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grey_opacity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">secular_ejecta_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">total_ejecta_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">disk_unbinding_efficiency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mass_ratio_threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">transient_duration</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
        <span class="n">min_wave</span><span class="o">=</span><span class="mf">500.0</span><span class="p">,</span>
        <span class="n">max_wave</span><span class="o">=</span><span class="mf">12000.0</span><span class="p">,</span>
        <span class="n">EOS_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">opacity_data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">emulator_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">only_draw_parameters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># give each transient an id to differentiate simulations</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># set instance attributes from inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_wave</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_wave</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_wave</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_wave</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transient_duration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">transient_duration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_ratio_threshold</span> <span class="o">=</span> <span class="n">mass_ratio_threshold</span>
        <span class="c1"># Set default data directories</span>
        <span class="k">if</span> <span class="n">EOS_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">EOS_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;kilopop&#39;</span><span class="p">,</span> <span class="s2">&quot;data/mr_sfho_full_right.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EOS_path</span> <span class="o">=</span> <span class="n">EOS_path</span>
        <span class="k">if</span> <span class="n">emulator_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emulator_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;kilopop&#39;</span><span class="p">,</span>
                                                            <span class="s2">&quot;data/paper_kernel_hyperparameters_journal_ref_v1.npy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_path</span> <span class="o">=</span> <span class="n">emulator_path</span>
        <span class="k">if</span> <span class="n">opacity_data_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">opacity_data_path</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;kilopop&#39;</span><span class="p">,</span>
                                                                <span class="s2">&quot;data/paper_opacity_data_journal_ref_v1.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opacity_data_path</span> <span class="o">=</span> <span class="n">opacity_data_path</span>

        <span class="c1"># Handle setup of EOS dependent mapping objects and set as class attributes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">EOS_mass_to_rad</span><span class="p">:</span>
            <span class="n">E1</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">get_EOS_table</span><span class="p">(</span><span class="n">EOS_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">EOS_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">get_max_EOS_mass</span><span class="p">(</span><span class="n">E1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">EOS_mass_to_rad</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">get_radius_interpolator_from_EOS</span><span class="p">(</span><span class="n">E1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">threshold_mass</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_7</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">EOS_mass_to_rad</span>
            <span class="p">)</span>
        <span class="c1"># Handle setup of Gaussian process emulator</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">grey_opacity_emulator</span><span class="p">:</span>
            <span class="p">(</span>
             <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">opacity_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">grey_opacity_emulator</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">construct_opacity_gaussian_process</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opacity_data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emulator_path</span>
            <span class="p">)</span>

        <span class="c1"># Instantiate parameter values as none to be filled in later</span>
        <span class="c1"># Set the parameter names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param1_name</span> <span class="o">=</span> <span class="s2">&quot;mass1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param2_name</span> <span class="o">=</span> <span class="s2">&quot;mass2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param3_name</span> <span class="o">=</span> <span class="s2">&quot;compactness1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param4_name</span> <span class="o">=</span> <span class="s2">&quot;compactness2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param5_name</span> <span class="o">=</span> <span class="s2">&quot;viewing_angle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param6_name</span> <span class="o">=</span> <span class="s2">&quot;electron_fraction&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param7_name</span> <span class="o">=</span> <span class="s2">&quot;dynamical_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param8_name</span> <span class="o">=</span> <span class="s2">&quot;median_ejecta_velocity&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param9_name</span> <span class="o">=</span> <span class="s2">&quot;grey_opacity&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param10_name</span> <span class="o">=</span> <span class="s2">&quot;secular_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param11_name</span> <span class="o">=</span> <span class="s2">&quot;total_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param12_name</span> <span class="o">=</span> <span class="s2">&quot;disk_unbinding_efficiency&quot;</span>

        <span class="c1"># initialize attributes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;param</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># parse user-provided parameter values</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mass1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mass1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">mass1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided mass is not compatible with the EOS.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mass2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mass2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">mass2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided mass is not compatible with the EOS.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compactness1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">compactness1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compactness2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">compactness2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">viewing_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param5</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">viewing_angle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">electron_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param6</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">electron_fraction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dynamical_ejecta_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param7</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dynamical_ejecta_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">median_ejecta_velocity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">median_ejecta_velocity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grey_opacity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param9</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grey_opacity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">secular_ejecta_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">secular_ejecta_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_ejecta_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_ejecta_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disk_unbinding_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">disk_unbinding_efficiency</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">draw_parameters</span><span class="p">()</span>
        <span class="c1"># if not only drawing parameters also create the spectral timeseries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_draw_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_spectral_timeseries</span><span class="p">()</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">TimeSeriesSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SAEE kilonova&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>  <span class="c1"># add dust effect here.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_mpc</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Currently always start the model at zero phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">maxtime</span><span class="p">()</span></div>

<div class="viewcode-block" id="bns_kilonova.draw_parameters"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.draw_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">draw_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw parameters not populated by the user.</span>

<span class="sd">        Wrapper function to sample the generating parameter distributions from</span>
<span class="sd">        Setzer et al 2022.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.param1: float</span>
<span class="sd">            The gravitational mass of the first neutron star.</span>
<span class="sd">        self.param2: float</span>
<span class="sd">            The gravitational mass of the second neutron star.</span>
<span class="sd">        self.param3: float</span>
<span class="sd">            The stellar compactness of the first neutron star.</span>
<span class="sd">        self.param4: float</span>
<span class="sd">            The stellar compactness of the second neutron star.</span>
<span class="sd">        self.param5: float</span>
<span class="sd">            The viewing angle of the observer with respect to the merger.</span>
<span class="sd">        self.param6: float</span>
<span class="sd">            The electron fraction along the line of sight of the observer.</span>
<span class="sd">        self.param7: float</span>
<span class="sd">            The total ejecta mass of the expanding kilonova material.</span>
<span class="sd">        self.param8: float</span>
<span class="sd">            The mean ejecta velocity of the expanding kilonova material.</span>
<span class="sd">        self.param9: float</span>
<span class="sd">            The grey opacity of the material along the line of sight of the</span>
<span class="sd">            observer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_from_binary_population</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_mass_to_compactness</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_to_kilonova_ejecta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_emulator_bounds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulate_grey_opacity</span><span class="p">()</span></div>

<div class="viewcode-block" id="bns_kilonova.draw_from_binary_population"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.draw_from_binary_population">[docs]</a>    <span class="k">def</span> <span class="nf">draw_from_binary_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw from the population priors on masses and inclination. Wrapper</span>
<span class="sd">        to population functions to populate instance parameters with draws from</span>
<span class="sd">        the population distributions.</span>

<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.param1: float or Array</span>
<span class="sd">            The mass of the primary (larger) neutron star. [solar masses]</span>
<span class="sd">        self.param2: float or Array</span>
<span class="sd">            The mass of the secondary neutron star. [solar masses]</span>
<span class="sd">        self.param5: float or Array</span>
<span class="sd">            The viewing angle of the observer w.r.t. the kilonova. [rads]</span>
<span class="sd">        self.param12: float or Array</span>
<span class="sd">            The unbinding efficiency of the remnant disk.</span>
<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Draw masses based on what is provided.</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param2</span>
             <span class="p">)</span> <span class="o">=</span> <span class="n">population_priors</span><span class="o">.</span><span class="n">draw_masses_from_EOS_bounds_with_mass_ratio_cut</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">tov_mass</span><span class="p">,</span> <span class="n">mass_ratio_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_ratio_threshold</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">population_priors</span><span class="o">.</span><span class="n">draw_mass_from_EOS_bounds</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__tov_mass</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_ratio_threshold</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span><span class="p">),</span>
                <span class="n">m_low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">population_priors</span><span class="o">.</span><span class="n">draw_mass_from_EOS_bounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="p">,</span> <span class="n">m_low</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_ratio_threshold</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="c1"># If not already set, draw the viewing angles</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param5</span> <span class="o">=</span> <span class="n">population_priors</span><span class="o">.</span><span class="n">draw_viewing_angle</span><span class="p">()</span>
        <span class="c1"># Disk unbinding efficiency</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="o">=</span> <span class="n">population_priors</span><span class="o">.</span><span class="n">draw_disk_unbinding_efficiency</span><span class="p">()</span></div>

<div class="viewcode-block" id="bns_kilonova.map_mass_to_compactness"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.map_mass_to_compactness">[docs]</a>    <span class="k">def</span> <span class="nf">map_mass_to_compactness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper function to the equation of state mappings.</span>
<span class="sd">        Using the inverse function interpolated from the given EOS mass-radius</span>
<span class="sd">        table, compute the compactness for a given mass.</span>

<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.param3: float or Array</span>
<span class="sd">            The compactness of the primary (larger) mass neutron star.</span>
<span class="sd">        self.param4: float or Array</span>
<span class="sd">            The compactness of the secondary (smaller) mass neutron star.</span>
<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># only compute if not already set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param3</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">compute_compactnesses_from_EOS</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">EOS_mass_to_rad</span>
            <span class="p">)</span>
        <span class="c1"># only compute if not already set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">compute_compactnesses_from_EOS</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">EOS_mass_to_rad</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="bns_kilonova.map_to_kilonova_ejecta"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.map_to_kilonova_ejecta">[docs]</a>    <span class="k">def</span> <span class="nf">map_to_kilonova_ejecta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper function to compute all of the kilonova ejecta, apart from</span>
<span class="sd">        emulation of the grey opacity given the ejecta parameters.</span>

<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.param6: float or Array</span>
<span class="sd">            The mass-weighted electron fraction composition of the ejecta</span>
<span class="sd">            along the line-of-sight of the observer viewing-angle.</span>
<span class="sd">        self.param7: float or Array</span>
<span class="sd">            The mass of the dynamical ejecta component of the kilonova.</span>
<span class="sd">            [solar masses]</span>
<span class="sd">        self.param8: float or Array</span>
<span class="sd">            The median velocity of the dynamical ejecta. [c]</span>
<span class="sd">        self.param10: float or Array</span>
<span class="sd">            The mass of the secular ejecta component of the kilonova.</span>
<span class="sd">            [solar masses]</span>
<span class="sd">        self.param11: float or Array</span>
<span class="sd">            The total ejecta mass contributing to the kilonova.</span>
<span class="sd">            [solar masses]</span>
<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Electron fraction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param6</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param5</span><span class="p">)</span>
        <span class="c1"># Dynamical Ejecta</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param8</span><span class="p">):</span>
            <span class="n">dynamical_ejecta_mass</span><span class="p">,</span> <span class="n">median_ejecta_velocity</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">map_to_dynamical_ejecta</span><span class="p">(</span>
                <span class="n">mass1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="p">,</span>
                <span class="n">comp1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param3</span><span class="p">,</span>
                <span class="n">mass2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param2</span><span class="p">,</span>
                <span class="n">comp2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param4</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param7</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param7</span> <span class="o">=</span> <span class="n">dynamical_ejecta_mass</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="o">=</span> <span class="n">median_ejecta_velocity</span>

        <span class="c1"># Secular Ejecta and Total Ejecta Mass</span>
        <span class="n">total_binary_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">param2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">compute_secular_ejecta_mass</span><span class="p">(</span><span class="n">total_binary_mass</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">threshold_mass</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">param12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_9</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">param7</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span><span class="o">/</span><span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_6</span><span class="p">(</span><span class="n">total_binary_mass</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">threshold_mass</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span><span class="o">/</span><span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_6</span><span class="p">(</span><span class="n">total_binary_mass</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">threshold_mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">compute_equation_9</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param10</span><span class="p">)</span></div>

<div class="viewcode-block" id="bns_kilonova.emulate_grey_opacity"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.emulate_grey_opacity">[docs]</a>    <span class="k">def</span> <span class="nf">emulate_grey_opacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper function to emulate the grey opacity as the last step in</span>
<span class="sd">        populating the transient instance with kilonova parameters.</span>

<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.param9: float or Array</span>
<span class="sd">            The grey opacity of the ejecta.</span>
<span class="sd">        &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param9</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param9</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="n">emulate_grey_opacity_from_kilonova_ejecta</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param11</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param8</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param6</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">grey_opacity_emulator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">opacity_data</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="bns_kilonova.enforce_emulator_bounds"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.enforce_emulator_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">enforce_emulator_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Impose emulator boundary conditions for validity.</span>

<span class="sd">        Imposes the boundary conditions we are limited to by our training data</span>
<span class="sd">        for the Gaussian process emulator.</span>

<span class="sd">        If the drawn parameters not fall with the bounds re-draw consistently</span>
<span class="sd">        from the population.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># impose velocity region boundary conditions for heating rates and</span>
        <span class="c1"># emulator</span>
        <span class="k">while</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">&gt;</span> <span class="mf">0.08</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">&lt;</span> <span class="mf">0.002</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> The requested kilonova cannot be generated due to ejecta predictions falling outside the emulator</span><span class="se">\&#39;</span><span class="s1">s range of validity for the following parameters:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_parameters</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param7</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param8</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param10</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># as the disk unbinding efficiency is independent only redraw if</span>
            <span class="c1"># the parameters it impacts are outside the bounds</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">&gt;</span> <span class="mf">0.08</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">&lt;</span> <span class="mf">0.002</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param12</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param11</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_from_binary_population</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_mass_to_compactness</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_to_kilonova_ejecta</span><span class="p">()</span></div>

<div class="viewcode-block" id="bns_kilonova.create_spectral_timeseries"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.create_spectral_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">create_spectral_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">KNE_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the spectral energy density timeseries for this kilonova</span>
<span class="sd">        instance.</span>

<span class="sd">        First layer wrapper function to FORTRAN library that computes the</span>
<span class="sd">        kilonova SED evolution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        KNE_parameters: list</span>
<span class="sd">            List of parameters needed to generate the kilonova SED. List format</span>
<span class="sd">            input instead of inputting mej, vej, etc. separately. Default=None.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>
<span class="sd">        self.phase: float array</span>
<span class="sd">            The phases in days where the kilonova SEDs are defined.</span>
<span class="sd">        self.wave: float array</span>
<span class="sd">            The discrete wavelengths at which fluxes are defined for a</span>
<span class="sd">            given phase.</span>
<span class="sd">        self.flux: float array</span>
<span class="sd">            The flux values for each combination of phase and wavelength.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">KNE_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">KNE_parameters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">600.0</span> <span class="o">/</span> <span class="mf">86400.0</span><span class="p">)</span>  <span class="c1"># starting time [days] (10 minutes)</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transient_duration</span><span class="p">)</span>  <span class="c1"># ending time [days]</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param11</span><span class="p">)</span>  <span class="c1"># total ejecta mass</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param8</span><span class="p">)</span>  <span class="c1"># median ejecta velocity</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.3</span><span class="p">)</span>  <span class="c1"># heating rate exponent (not used)</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># thermalization factor</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># DZ enhancement</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param9</span><span class="p">)</span>  <span class="c1"># The grey opacity</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">150.0</span><span class="p">)</span>  <span class="c1"># Initial temperature [K]</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param6</span><span class="p">)</span>  <span class="c1"># Electron fraction</span>
            <span class="c1"># Not reading heating rates from file so feed fortran dummy</span>
            <span class="c1"># variables</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>  <span class="c1"># Flag to use numerical fit nuclear heating rates</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>  <span class="c1"># Flag to use numerical fit thermalisation efficiency</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Read heating rates variable</span>
            <span class="n">KNE_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;placeholder string&quot;</span><span class="p">)</span>  <span class="c1"># Heating rates file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">create_saee_seds</span><span class="p">(</span>
            <span class="n">KNE_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_wave</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="bns_kilonova.print_parameters"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonova.html#kilopop.kilonovae.bns_kilonova.print_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">print_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Util function to print parameters of simulated kN.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;param</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;param</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="bns_kilonovae_population_distribution"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonovae_population_distribution.html#kilopop.kilonovae.bns_kilonovae_population_distribution">[docs]</a><span class="k">class</span> <span class="nc">bns_kilonovae_population_distribution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to construct population from Setzer et al. 2022.</span>

<span class="sd">    This class holds attributes which are vectors of each parameter of the</span>
<span class="sd">    population.</span>

<span class="sd">    The user can generate a new population, based on size,</span>
<span class="sd">    otherwise the population from the paper is imported.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    bns_kilonovae_population_distribution: class instance</span>
<span class="sd">        Attributes of the class object are self.paramsi where i is in</span>
<span class="sd">        range(12) and are arrays of the distributions corresponding to each</span>
<span class="sd">        parameter.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="bns_kilonovae_population_distribution.__init__"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonovae_population_distribution.html#kilopop.kilonovae.bns_kilonovae_population_distribution.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">population_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
        <span class="n">only_draw_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        population_size: int</span>
<span class="sd">            The size of the population to be drawn from the population. Default is 50000.</span>
<span class="sd">        only_draw_parameters: boolean (optional)</span>
<span class="sd">            Flag whether to generate only the parameter distributions, or to</span>
<span class="sd">            also simulate the lightcurves and derive the properties presented in</span>
<span class="sd">            the paper. Default is True.</span>
<span class="sd">        chunksize: int (optional)</span>
<span class="sd">            If computing properties from the lightcurves this option will</span>
<span class="sd">            batch the computation into chunks for multiprocessing. Default is 500.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">=</span> <span class="n">population_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="c1"># Set the parameter names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param1_name</span> <span class="o">=</span> <span class="s2">&quot;mass1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param2_name</span> <span class="o">=</span> <span class="s2">&quot;mass2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param3_name</span> <span class="o">=</span> <span class="s2">&quot;compactness1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param4_name</span> <span class="o">=</span> <span class="s2">&quot;compactness2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param5_name</span> <span class="o">=</span> <span class="s2">&quot;viewing_angle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param6_name</span> <span class="o">=</span> <span class="s2">&quot;electron_fraction&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param7_name</span> <span class="o">=</span> <span class="s2">&quot;dynamical_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param8_name</span> <span class="o">=</span> <span class="s2">&quot;median_ejecta_velocity&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param9_name</span> <span class="o">=</span> <span class="s2">&quot;grey_opacity&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param10_name</span> <span class="o">=</span> <span class="s2">&quot;secular_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param11_name</span> <span class="o">=</span> <span class="s2">&quot;total_ejecta_mass&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param12_name</span> <span class="o">=</span> <span class="s2">&quot;disk_unbinding_efficiency&quot;</span>

        <span class="c1"># initialize parameter arrays for distributions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;param</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">))</span>

        <span class="c1"># populate the parameter distributions</span>
        <span class="k">if</span> <span class="n">only_draw_parameters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)):</span>
                <span class="n">kilonova</span> <span class="o">=</span> <span class="n">bns_kilonova</span><span class="p">(</span><span class="n">only_draw_parameters</span><span class="o">=</span><span class="n">only_draw_parameters</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">):</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="nb">getattr</span><span class="p">(</span><span class="n">kilonova</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initialize attributes computed in paper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_absmag_lssti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one_mag_peak_time_lssti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)</span>
            <span class="c1"># use multiprocessing to accelerate compuation of lightcurves and</span>
            <span class="c1"># derived properties.</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">))</span> <span class="k">as</span> <span class="n">progress_bar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parameter_dict</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_lightcurve_properties_per_kilonova</span><span class="p">,</span>
                                                           <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)),</span>
                                                           <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">):</span>
                        <span class="nb">id</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">peak_time</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;peak_time&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">peak_absmag_lssti</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;peak_absmag_lssti&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">one_mag_peak_time_lssti</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;one_mag_peak_time_lssti&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">):</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">)]</span>
                        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="bns_kilonovae_population_distribution.compute_lightcurve_properties_per_kilonova"><a class="viewcode-back" href="../../api/kilopop.kilonovae.bns_kilonovae_population_distribution.html#kilopop.kilonovae.bns_kilonovae_population_distribution.compute_lightcurve_properties_per_kilonova">[docs]</a>    <span class="k">def</span> <span class="nf">compute_lightcurve_properties_per_kilonova</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper function to execute the per-kilonova population draws and</span>
<span class="sd">        computation of light curve properties in parallel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        id: int</span>
<span class="sd">            The id of the transient being generated for record keeping</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        parameter_dict: dict</span>
<span class="sd">            Dictionary construct containing all the parameters set for the</span>
<span class="sd">            population.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameter_dict</span> <span class="o">=</span> <span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">)],</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">kilonova</span> <span class="o">=</span> <span class="n">bns_kilonova</span><span class="p">(</span><span class="n">only_draw_parameters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">kilonova</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">maxtime</span><span class="p">(),</span> <span class="mi">5001</span><span class="p">)</span>
        <span class="n">lightcurve_abs_i</span> <span class="o">=</span> <span class="n">kilonova</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bandmag</span><span class="p">(</span><span class="s1">&#39;lssti&#39;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
        <span class="n">peak_abs_lssti</span> <span class="o">=</span> <span class="n">kilonova</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">peakmag</span><span class="p">(</span><span class="s1">&#39;lssti&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">one_mag_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lightcurve_abs_i</span> <span class="o">&lt;=</span> <span class="n">peak_abs_lssti</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">one_mag_total_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">one_mag_indices</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="n">one_mag_indices</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;peak_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kilonova</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">peakphase</span><span class="p">(</span><span class="s1">&#39;lssti&#39;</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;one_mag_peak_time_lssti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_mag_total_time</span>
        <span class="n">parameter_dict</span><span class="p">[</span><span class="s1">&#39;peak_absmag_lssti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_abs_lssti</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">):</span>
            <span class="n">parameter_dict</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">kilonova</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kilonova</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parameter_dict</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Christian N. Setzer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>